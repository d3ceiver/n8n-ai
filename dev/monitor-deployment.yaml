apiVersion: apps/v1
kind: Deployment
metadata:
  name: n8n-monitor
  namespace: ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: n8n-monitor
  template:
    metadata:
      labels:
        app: n8n-monitor
    spec:
      containers:
        - name: n8n-monitor
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              #!/bin/sh
              WEBHOOK_BOOT="http://192.168.0.59:32000/webhook/pi-boot"
              WEBHOOK_RECOVERED="http://192.168.0.59:32000/webhook/n8n-recovered"
              CHECK_URL="http://192.168.0.59:32000/"
              LOG_FILE="/tmp/n8n-monitor.log"
              STATE="down"

              echo "$(date): n8n monitor pod started." | tee -a "$LOG_FILE"
              echo "$(date): Waiting for n8n to become available..." | tee -a "$LOG_FILE"

              # Wait for n8n to become reachable
              until curl -fs -o /dev/null "$CHECK_URL"; do
                echo "$(date): n8n not reachable yet, retrying in 5s..." | tee -a "$LOG_FILE"
                sleep 5
              done

              echo "$(date): n8n is now UP → attempting boot webhook..." | tee -a "$LOG_FILE"

              # Retry boot webhook until it succeeds
              while true; do
                if curl -fs -X POST "$WEBHOOK_BOOT" -o /dev/null; then
                  echo "$(date): Boot webhook sent successfully!" | tee -a "$LOG_FILE"
                  STATE="up"
                  break
                else
                  echo "$(date): Boot webhook not ready yet (retrying in 10s)..." | tee -a "$LOG_FILE"
                  sleep 10
                fi
              done

              # Continuous monitoring loop
              while true; do
                if curl -fs -o /dev/null "$CHECK_URL"; then
                  if [ "$STATE" = "down" ]; then
                    echo "$(date): n8n recovered → sending recovery webhook" | tee -a "$LOG_FILE"
                    if curl -fs -X POST "$WEBHOOK_RECOVERED" -o /dev/null; then
                      echo "$(date): Recovery webhook sent successfully!" | tee -a "$LOG_FILE"
                    else
                      echo "$(date): Recovery webhook failed!" | tee -a "$LOG_FILE"
                    fi
                    STATE="up"
                  fi
                else
                  if [ "$STATE" = "up" ]; then
                    echo "$(date): n8n appears down." | tee -a "$LOG_FILE"
                    STATE="down"
                  fi
                fi
                sleep 15
              done
          resources:
            requests:
              cpu: "10m"
              memory: "16Mi"
            limits:
              cpu: "50m"
              memory: "32Mi"
