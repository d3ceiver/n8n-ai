apiVersion: apps/v1
kind: Deployment
metadata:
  name: n8n-monitor
  namespace: ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: n8n-monitor
  template:
    metadata:
      labels:
        app: n8n-monitor
    spec:
      restartPolicy: Always
      containers:
        - name: n8n-monitor
          image: busybox:1.36
          command:
            - /bin/sh
            - -c
            - |
              echo "$(date): n8n monitor pod started."
              WEBHOOK_BOOT="http://192.168.0.59:32000/webhook/pi-boot"
              WEBHOOK_RECOVERED="http://192.168.0.59:32000/webhook/n8n-recovered"
              CHECK_URL="http://192.168.0.59:32000/"
              STATE="init"

              echo "$(date): Waiting for n8n to become available..."

              # Wait for n8n to respond
              until wget -q --spider "$CHECK_URL"; do
                echo "$(date): n8n still down, retrying in 10s..."
                sleep 10
              done

              echo "$(date): n8n is now UP → trying boot webhook..."

              # Keep retrying until webhook call succeeds
              until wget -q --spider "$WEBHOOK_BOOT"; do
                echo "$(date): Boot webhook not ready yet (retrying in 10s)..."
                sleep 10
              done

              echo "$(date): Boot webhook sent successfully!"
              STATE="up"

              # --- Continuous monitor ---
              while true; do
                if wget -q --spider "$CHECK_URL"; then
                  if [ "$STATE" = "down" ]; then
                    echo "$(date): n8n recovered → sending webhook"
                    until wget -q --spider "$WEBHOOK_RECOVERED"; do
                      echo "$(date): Recovery webhook not ready yet (retrying in 10s)..."
                      sleep 10
                    done
                    echo "$(date): Recovery webhook sent successfully!"
                    STATE="up"
                  fi
                else
                  if [ "$STATE" != "down" ]; then
                    echo "$(date): n8n appears down."
                    STATE="down"
                  fi
                fi
                sleep 30
              done
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi

