apiVersion: apps/v1
kind: Deployment
metadata:
  name: n8n-monitor
  namespace: ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: n8n-monitor
  template:
    metadata:
      labels:
        app: n8n-monitor
    spec:
      containers:
        - name: n8n-monitor
          image: busybox:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "$(date): Starting n8n-monitor..."
              
              WEBHOOK_BOOT="http://192.168.0.59:32000/webhook/pi-boot"
              WEBHOOK_RECOVERED="http://192.168.0.59:32000/webhook/n8n-recovered"
              CHECK_URL="http://192.168.0.59:32000/"
              STATE=""

              echo "$(date): Sending boot webhook..."
              wget -qO- --post-data='' "$WEBHOOK_BOOT" >/dev/null 2>&1

              while true; do
                if wget -q --spider "$CHECK_URL"; then
                  if [ "$STATE" = "down" ]; then
                    echo "$(date): n8n recovered â†’ sending webhook"
                    wget -qO- --post-data='' "$WEBHOOK_RECOVERED" >/dev/null 2>&1
                    STATE="up"
                  fi
                  [ -z "$STATE" ] && STATE="up"
                else
                  if [ "$STATE" = "up" ] || [ -z "$STATE" ]; then
                    echo "$(date): n8n appears down"
                    STATE="down"
                  fi
                fi
                sleep 30
              done
          restartPolicy: Always
