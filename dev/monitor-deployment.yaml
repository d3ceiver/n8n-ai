apiVersion: apps/v1
kind: Deployment
metadata:
  name: n8n-monitor
  namespace: ai
spec:
  replicas: 0
  selector:
    matchLabels:
      app: n8n-monitor
  template:
    metadata:
      labels:
        app: n8n-monitor
    spec:
      containers:
        - name: n8n-monitor
          image: curlimages/curl:latest
          command: ["/bin/sh", "-c"]
          args:
            - |
              LOG_FILE="/tmp/n8n-monitor.log"
              WEBHOOK_BOOT="http://192.168.0.59:32000/webhook/pi-boot"
              WEBHOOK_RECOVERED="http://192.168.0.59:32000/webhook/n8n-recovered"
              CHECK_URL="http://192.168.0.59:32000/"

              echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): n8n monitor pod started." | tee -a $LOG_FILE

              # Wait for n8n to become reachable
              until curl -fs --max-time 5 "$CHECK_URL" > /dev/null 2>&1; do
                echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): Waiting for n8n to become available..." | tee -a $LOG_FILE
                sleep 10
              done

              echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): n8n is now UP → sending boot webhook..." | tee -a $LOG_FILE

              # Keep retrying boot webhook until success (GET request, not POST)
              while true; do
                STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEBHOOK_BOOT")
                if [ "$STATUS" -eq 200 ]; then
                  echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): Boot webhook sent successfully!" | tee -a $LOG_FILE
                  break
                else
                  echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): Boot webhook failed (HTTP $STATUS), retrying in 10s..." | tee -a $LOG_FILE
                  sleep 10
                fi
              done

              STATE="up"

              # Continuous monitor loop
              while true; do
                if curl -fs --max-time 5 "$CHECK_URL" > /dev/null 2>&1; then
                  if [ "$STATE" = "down" ]; then
                    echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): n8n recovered → sending recovery webhook" | tee -a $LOG_FILE
                    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEBHOOK_RECOVERED")
                    if [ "$STATUS" -eq 200 ]; then
                      echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): Recovery webhook sent successfully!" | tee -a $LOG_FILE
                      STATE="up"
                    else
                      echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): Recovery webhook failed (HTTP $STATUS)" | tee -a $LOG_FILE
                    fi
                  fi
                else
                  if [ "$STATE" = "up" ]; then
                    echo "$(date -u '+%Y-%m-%d %H:%M:%S UTC'): n8n appears down" | tee -a $LOG_FILE
                    STATE="down"
                  fi
                fi
                sleep 30
              done
          resources:
            requests:
              cpu: 50m
              memory: 32Mi
            limits:
              cpu: 100m
              memory: 64Mi
